# GitLab CI/CD component template for Airflow DAG deployment

variables:
  SFTP_HOST: "$SFTP_HOST"
  SFTP_USERNAME: "$SFTP_USERNAME"
  SFTP_PASSWORD: "$SFTP_PASSWORD"
  SFTP_PORT: "$SFTP_PORT"
  SFTP_DAGS_PATH: "$SFTP_DAGS_PATH"

.before_script:
  before_script:
    - |
      if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ] && [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" = "main" ]; then
        export ENVIRONMENT=dev
      elif [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ] && [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" = "main" ] && [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" = "production" ]; then
        export ENVIRONMENT=staging
      elif [ "$CI_COMMIT_TAG" != "" ] && [ "$CI_COMMIT_REF_PROTECTED" = "true" ] && [ "$CI_COMMIT_BRANCH" = "production" ]; then
        export ENVIRONMENT=production
      else
        echo "Error: Unable to determine the environment for deployment."
        exit 1
      fi
      echo "ENVIRONMENT=$ENVIRONMENT"

ruff:
  stage: quality
  image: python:3.12
  extends: .before_script
  script:
    - pip install uv
    - uvx ruff check src/ --output-format=github
  only:
    - main
    - merge_requests

mypy:
  stage: quality
  image: python:3.12
  extends: .before_script
  script:
    - pip install uv
    - uvx mypy src/
  only:
    - main
    - merge_requests

bandit:
  stage: quality
  image: python:3.12
  extends: .before_script
  script:
    - pip install uv
    - uvx bandit -r src/
  only:
    - main
    - merge_requests

ty:
  stage: quality
  image: python:3.12
  extends: .before_script
  script:
    - pip install uv
    - uvx ty check src/
  only:
    - main
    - merge_requests

publish:
  stage: publish
  image: alpine:3.18
  extends: .before_script
  needs:
    - ruff
    - mypy
    - bandit
    - ty
  script:
    - apk add --no-cache lftp
    - lftp -u "$SFTP_USERNAME","$SFTP_PASSWORD" -e "mirror -R src $SFTP_DAGS_PATH/$ENVIRONMENT; bye" -p $SFTP_PORT $SFTP_HOST
  only:
    - main
    - tags
  when: on_success

tag_production:
  stage: publish
  image: curlimages/curl:8.5.0
  needs: []
  extends: .before_script
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ] && [ "$CI_PIPELINE_SOURCE" = "push" ]; then
        TAG_NAME="prod-$(date +%Y%m%d%H%M%S)"
        echo "Creating tag $TAG_NAME on production branch via GitLab API..."
        curl --request POST --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          --data "tag_name=$TAG_NAME&ref=production" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/tags"
      else
        echo "Not a push on production, skipping tag creation."
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "production" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: never
