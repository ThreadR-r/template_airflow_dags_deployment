name: Airflow DAG CI/CD Component

on:
  push:
    branches: [ main, production ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, production ]

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.setenv.outputs.environment }}
    steps:
      - name: Compute environment type
        id: setenv
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/main ]]; then
            ENV_TYPE="dev"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/staging ]]; then
            ENV_TYPE="staging"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/production ]]; then
            ENV_TYPE="production"
          else
            echo "Unsupported event type or branch: ${GITHUB_EVENT_NAME} on ${GITHUB_REF}"
            exit 1
          fi
          echo "environment=$ENV_TYPE" >> $GITHUB_OUTPUT
          echo "Computed environment type: $ENV_TYPE"

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Export and Install project dependencies
        run: |
          /root/.local/bin/uv sync --frozen

      - name: Lint with ruff
        run: /root/.local/bin/uv run --with ruff ruff check src
        continue-on-error: true

      - name: Type check with ty
        run: /root/.local/bin/uv run --with ty ty check src
        continue-on-error: true

      - name: Security check with bandit
        run: /root/.local/bin/uv run --with bandit bandit -r src
        continue-on-error: true

      # - name: Run TruffleHog
      #   uses: trufflesecurity/trufflehog@main
      #   with:
      #     extra_args: --results=verified,unknown

  publish:
    needs: [set-environment, tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load SFTP secrets for dev
        if: needs.set-environment.outputs.environment == 'dev'
        run: |
          if [ -z "${{ secrets.SFTP_HOST_DEV }}" ] || [ -z "${{ secrets.SFTP_PORT_DEV }}" ] || [ -z "${{ secrets.SFTP_USER_DEV }}" ] || [ -z "${{ secrets.SFTP_PASSWORD_DEV }}" ] || [ -z "${{ secrets.SFTP_TARGET_DIR_DEV }}" ]; then
            echo "Missing one or more SFTP_*_DEV secrets (SFTP_HOST_DEV, SFTP_PORT_DEV, SFTP_USER_DEV, SFTP_PASSWORD_DEV, SFTP_TARGET_DIR_DEV)" >&2
            exit 1
          fi
          echo "SFTP_HOST=${{ secrets.SFTP_HOST_DEV }}" >> $GITHUB_ENV
          echo "SFTP_PORT=${{ secrets.SFTP_PORT_DEV }}" >> $GITHUB_ENV
          echo "SFTP_USER=${{ secrets.SFTP_USER_DEV }}" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=${{ secrets.SFTP_PASSWORD_DEV }}" >> $GITHUB_ENV
          echo "SFTP_TARGET_DIR=${{ secrets.SFTP_TARGET_DIR_DEV }}" >> $GITHUB_ENV
          echo "Loaded SFTP secrets for dev environment"

      - name: Load SFTP secrets for staging
        if: needs.set-environment.outputs.environment == 'staging'
        run: |
          if [ -z "${{ secrets.SFTP_HOST_STAGING }}" ] || [ -z "${{ secrets.SFTP_PORT_STAGING }}" ] || [ -z "${{ secrets.SFTP_USER_STAGING }}" ] || [ -z "${{ secrets.SFTP_PASSWORD_STAGING }}" ] || [ -z "${{ secrets.SFTP_TARGET_DIR_STAGING }}" ]; then
            echo "Missing one or more SFTP_*_STAGING secrets (SFTP_HOST_STAGING, SFTP_PORT_STAGING, SFTP_USER_STAGING, SFTP_PASSWORD_STAGING, SFTP_TARGET_DIR_STAGING)" >&2
            exit 1
          fi
          echo "SFTP_HOST=${{ secrets.SFTP_HOST_STAGING }}" >> $GITHUB_ENV
          echo "SFTP_PORT=${{ secrets.SFTP_PORT_STAGING }}" >> $GITHUB_ENV
          echo "SFTP_USER=${{ secrets.SFTP_USER_STAGING }}" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=${{ secrets.SFTP_PASSWORD_STAGING }}" >> $GITHUB_ENV
          echo "SFTP_TARGET_DIR=${{ secrets.SFTP_TARGET_DIR_STAGING }}" >> $GITHUB_ENV
          echo "Loaded SFTP secrets for staging environment"

      - name: Load SFTP secrets for production
        if: needs.set-environment.outputs.environment == 'production'
        run: |
          if [ -z "${{ secrets.SFTP_HOST_PRODUCTION }}" ] || [ -z "${{ secrets.SFTP_PORT_PRODUCTION }}" ] || [ -z "${{ secrets.SFTP_USER_PRODUCTION }}" ] || [ -z "${{ secrets.SFTP_PASSWORD_PRODUCTION }}" ] || [ -z "${{ secrets.SFTP_TARGET_DIR_PRODUCTION }}" ]; then
            echo "Missing one or more SFTP_*_PRODUCTION secrets (SFTP_HOST_PRODUCTION, SFTP_PORT_PRODUCTION, SFTP_USER_PRODUCTION, SFTP_PASSWORD_PRODUCTION, SFTP_TARGET_DIR_PRODUCTION)" >&2
            exit 1
          fi
          echo "SFTP_HOST=${{ secrets.SFTP_HOST_PRODUCTION }}" >> $GITHUB_ENV
          echo "SFTP_PORT=${{ secrets.SFTP_PORT_PRODUCTION }}" >> $GITHUB_ENV
          echo "SFTP_USER=${{ secrets.SFTP_USER_PRODUCTION }}" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=${{ secrets.SFTP_PASSWORD_PRODUCTION }}" >> $GITHUB_ENV
          echo "SFTP_TARGET_DIR=${{ secrets.SFTP_TARGET_DIR_PRODUCTION }}" >> $GITHUB_ENV
          echo "Loaded SFTP secrets for production environment"

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Mirror src folder to SFTP
        run: |
          echo "Starting lftp mirror upload to $SFTP_HOST:$SFTP_TARGET_DIR..."
          lftp -u "$SFTP_USER,$SFTP_PASSWORD" -e "set sftp:connect-program 'ssh -a -x -o StrictHostKeyChecking=no'; mkdir -p $SFTP_TARGET_DIR; mirror -R src $SFTP_TARGET_DIR; bye" -p "$SFTP_PORT" sftp://$SFTP_HOST
